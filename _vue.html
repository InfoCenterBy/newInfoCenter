<div class="" id="app">
     <div class="d-flex justify-content-center">
          <h4 class="h4 d-block">Метод ввода данных</h4>
     </div>
     <div class="col-lg-8">
          <div class="d-flex flex-row justify-content-lg-end justify-content-center gap-3 mt-3">
               <button class="" :class="[inputMethod === 'manual'? 'btn-default' : 'btn-empty']" @click="inputMethod = 'manual'">Ручной ввод</button>
               <button class="" :class="[inputMethod === 'file'? 'btn-default' : 'btn-empty']" @click=" inputMethod = 'file'">Загрузка файла</button>
          </div>
     </div>
     <div class="mt-4"></div>
     <div v-if="inputMethod === 'manual'">
          <div class="col-lg-8">
               <form @submit.prevent="submitForm" class="needs-validation vue-form d-flex flex-column gap-3" novalidate>
                    <div class="d-flex flex-row">
                         <div class="form-floating w-100">
                              <input
                                   type="text"
                                   class="form-control pb-3 border-20"
                                   id="nameObject"
                                   placeholder=""
                                   v-model="formData.title"
                                   @input="updateCharCount('title', formData.title)"
                                   required
                                   :maxlength="charLimits.title.max"
                                   pattern='^(?:[А-ЯЁ][а-яё]+\s+[А-ЯЁ][а-яё]+(?:\s+[А-ЯЁ][а-яё]+)?|[А-ЯЁа-яё0-9\s\-"«».,]{3,200})$' />
                              <label for="nameObject">Наименование объекта</label>
                              <div class="invalid-feedback">Данные указаны неверно</div>
                         </div>
                         <div class="char-counter-wrapper">
                              <div class="char-counter">{{ updateCharCount('title', formData.title) }}</div>
                         </div>
                    </div>

                    <div class="d-flex flex-row">
                         <div class="form-floating w-100">
                              <input
                                   type="text"
                                   class="form-control pb-3 border-20"
                                   id="unp"
                                   placeholder=""
                                   v-model="formData.unp"
                                   @input="updateCharCount('title', formData.unp)"
                                   required
                                   :maxlength="charLimits.unp.max"
                                   pattern="^[А-Яа-яA-Za-z0-9]{9}$" />
                              <label for="unp">УНП</label>
                              <div class="invalid-feedback">Данные указаны неверно</div>
                         </div>
                         <div class="char-counter-wrapper">
                              <div class="char-counter">{{ updateCharCount('unp', formData.unp) }}</div>
                         </div>
                    </div>

                    <div class="d-flex flex-row">
                         <div class="form-floating w-100">
                              <input
                                   type="text"
                                   class="form-control pb-3 border-20"
                                   id="gniLocation"
                                   placeholder=""
                                   v-model="formData.gniLocation"
                                   @input="updateCharCount('title', formData.gniLocation)"
                                   required
                                   :maxlength="charLimits.gniLocation.max"
                                   pattern="^[0-9]{4}$" />
                              <label for="gniLocation">Код ИМНС</label>
                              <div class="invalid-feedback">Данные указаны неверно</div>
                         </div>
                         <div class="char-counter-wrapper">
                              <div class="char-counter">{{ updateCharCount('gniLocation', formData.gniLocation) }}</div>
                         </div>
                    </div>

                    <button class="btn-default" @click="addPositionFlag = true" v-if="!addPositionFlag" type="button">Добавить позицию</button>

                    <div class="border-20 p-4 bg-gray-bg-illustr" v-if="addPositionFlag">
                         <div class="positions-form d-flex flex-column gap-3">
                              <div class="d-flex flex-row">
                                   <div class="form-floating w-100">
                                        <input
                                             type="text"
                                             class="form-control pb-3 border-20"
                                             id="namePosition"
                                             placeholder=""
                                             v-model="newPosition.name"
                                             @input="updateCharCount('positionName', newPosition.name)"
                                             required
                                             :maxlength="charLimits.positionName.max"
                                             pattern='^(?:[А-ЯЁ][а-яё]+\s+[А-ЯЁ][а-яё]+(?:\s+[А-ЯЁ][а-яё]+)?|[А-ЯЁа-яё0-9\s\-"«».,]{3,200})$' />
                                        <label for="namePosition">Наименование маркированного товара</label>
                                        <div class="invalid-feedback">Данные указаны неверно</div>
                                   </div>
                                   <div class="char-counter-wrapper">
                                        <div class="char-counter">{{ updateCharCount('positionName', newPosition.name) }}</div>
                                   </div>
                              </div>

                              <div class="d-flex flex-row">
                                   <div class="form-floating w-100">
                                        <input
                                             type="number"
                                             class="form-control pb-3 border-20"
                                             id="productCountPosition"
                                             placeholder=""
                                             v-model="newPosition.productCount"
                                             required
                                             pattern="[0-9]{3,549755813887.99}"
                                             value="" />
                                        <label for="productCountPosition">Количество товара</label>
                                        <div class="invalid-feedback">Данные указаны неверно</div>
                                   </div>
                              </div>

                              <div class="d-flex flex-row">
                                   <div class="form-floating w-100">
                                        <input
                                             type="number"
                                             class="form-control pb-3 border-20"
                                             id="amountPosition"
                                             placeholder=""
                                             v-model="newPosition.amount"
                                             required
                                             pattern="[0-9]{3,549755813887.99}"
                                             value="" />
                                        <label for="amountPosition">Стоимость продажи единицы маркированного товара</label>
                                        <div class="invalid-feedback">Данные указаны неверно</div>
                                   </div>
                              </div>

                              <div class="d-flex flex-row">
                                   <div class="form-floating w-100">
                                        <input
                                             type="number"
                                             class="form-control pb-3 border-20"
                                             id="discountPosition"
                                             placeholder=""
                                             v-model="newPosition.discount"
                                             required
                                             pattern="[0-9]{3,549755813887.99}"
                                             value="" />
                                        <label for="discountPosition">Сумма скидки для маркированного товара</label>
                                        <div class="invalid-feedback">Данные указаны неверно</div>
                                   </div>
                              </div>

                              <div class="d-flex flex-row">
                                   <div class="input-group d-flex flex-row gap-2">
                                        <div class="form-floating">
                                             <input
                                                  type="text"
                                                  class="form-control pb-3 border-20"
                                                  id="eanPosition"
                                                  placeholder=""
                                                  v-model="newPosition.ean"
                                                  required
                                                  pattern="[0-9]{13}" />
                                             <label for="eanPosition">GTIN товара</label>
                                             <div class="invalid-feedback">Данные указаны неверно</div>
                                        </div>
                                        <button class="input-group-text btn-default rounded fs-24" @click="showModalScanGTIN()" type="button">
                                             <i class="bi bi-camera"></i>
                                        </button>
                                   </div>
                              </div>



                              <div class="d-flex flex-row">
                                   <div class="form-floating w-100">
                                        <input
                                             type="number"
                                             class="form-control pb-3 border-20"
                                             id="surchargePosition"
                                             placeholder=""
                                             v-model="newPosition.surcharge"
                                             required
                                             pattern="[0-9]{3,549755813887.99}" />
                                        <label for="surchargePosition">Сумма надбавки для маркированного товара</label>
                                        <div class="invalid-feedback">Данные указаны неверно</div>
                                   </div>
                              </div>


                              <button type="button" class="btn-default" @click="addPosition">Добавить позицию</button>
                         </div>
                         <div class="mt-5"></div>
                    </div>

                    <div class="mt-5 border-20 p-4 bg-gray-bg-illustr" v-if="hasPositions > 0">
                         <div class="positions-list">
                              <h3>Добавленные позиции:</h3>
                              <div class="position-item" v-for="(position, index) in formData.positions" :key="index">
                                   <p><strong>{{ position.name }}</strong></p>
                                   <p>Количество: {{ position.quantity }}</p>
                                   <p>Цена: {{ position.price }}</p>
                                   <button type="button" @click="removePosition(index)">Удалить</button>
                              </div>
                         </div>
                    </div>

                    <button type="submit" class="btn-default" :class="[!hasPositions ? 'disabled' : '']" :disabled="!hasPositions">Отправить данные</button>
               </form>
          </div>
     </div>

     <div v-if="inputMethod === 'file'">
          <div class="form-group">
               <label>Выберите файл для загрузки:</label>
               <input type="file" @change="handleFileUpload" accept=".json" />
          </div>

          <div v-if="fileData">
               <h3>Предпросмотр данных из файла:</h3>
               <pre>{{ fileData }}</pre>
               <button @click="submitFileData">Отправить данные</button>
          </div>
     </div>

     <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
               <div class="modal-content mt-0">
                    <div class="modal-header">
                         <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                         <div class="">
                              <button type="button" class="btn-default" id="startButton"></button>
                         </div>
                         <div>
                              <video id="video" width="300" height="200" style="border: 1px solid gray"></video>
                         </div>

                         <div id="sourceSelectPanel" style="display: none">
                              <label for="sourceSelect">Change video source:</label>
                              <select id="sourceSelect" style="max-width: 400px"></select>
                         </div>

                         <label>Result:</label>
                         <pre><code id="result"></code></pre>
                    </div>
                    <div class="modal-footer">
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                         <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
               </div>
          </div>
     </div>
</div>

<script>
     const { createApp, ref } = Vue;

     createApp({
          data() {
               return {
                    inputMethod: 'manual',
                    formData: {
                         title: '',
                         description: '',
                         positions: [],
                         unp: '',
                         messageNumber: '',
                         gniLocation: '',
                    },
                    newPosition: {
                         quantity: 1,
                         price: '',

                         name: '',
                         productCount: '', //Количество товара
                         amount: '', //Стоимость продажи единицы маркированного товара
                         discount: '', //Сумма скидки для маркированного товара
                         ean: '', //GTIN товара
                         markingCode: '', //Код маркировки
                         markingType: '', //Тип маркировки
                         surcharge: '', //Сумма надбавки для маркированного товара
                         ukzCode: '', //Код УКЗ -унифицированный контрольный знак
                    },
                    fileData: null,
                    charLimits: {
                         title: {
                              max: 200,
                              current: 0,
                         },
                         unp: {
                              max: 9,
                              current: 0,
                         },
                         messageNumber: {
                              max: 100,
                              current: 0,
                         },
                         gniLocation: {
                              max: 4,
                              current: 0,
                         },
                         description: {
                              max: 500,
                              current: 0,
                         },
                         positionName: {
                              max: 200,
                              current: 0,
                         },
                         markingCode: {
                              max: 256,
                              current: 0,
                         },
                         markingType: {
                              max: 3,
                              current: 0,
                         },
                         ukzCode: {
                              max: 64,
                              current: 0,
                         },
                    },
                    addPositionFlag: false,
                    codeReader: new ZXing.BrowserMultiFormatReader(),
               };
          },
          watch: {},
          computed: {
               hasPositions() {
                    return this.formData.positions.length > 0;
               },
          },
          methods: {
               addPosition() {
                    this.formData.positions.push({
                         name: this.newPosition.name,
                         quantity: parseInt(this.newPosition.quantity),
                         price: parseFloat(this.newPosition.price),
                    });

                    // Сброс формы позиции
                    this.newPosition = {
                         name: '',
                         quantity: 1,
                         price: 0,
                    };
                    // Сброс счетчика символов для имени позиции
                    this.charLimits.positionName.current = 0;
                    this.addPositionFlag = false;
               },
               removePosition(index) {
                    this.formData.positions.splice(index, 1);
               },
               submitForm() {
                    if (this.hasPositions) {
                    }
                    const form = document.querySelector('.needs-validation.vue-form');

                    if (!form.checkValidity()) {
                         event.preventDefault();
                         event.stopPropagation();
                    }
                    if (form.checkValidity()) {
                         const result = {
                              ...this.formData,
                              positions: [...this.formData.positions],
                         };

                         console.log('Итоговые данные:', result);
                         alert('Данные успешно сформированы (см. консоль)');
                    }

                    form.classList.add('was-validated');
               },
               handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                         try {
                              this.fileData = JSON.parse(e.target.result);
                         } catch (error) {
                              console.error('Ошибка чтения файла:', error);
                              alert('Неверный формат файла');
                         }
                    };
                    reader.readAsText(file);
               },
               submitFileData() {
                    if (!this.fileData) {
                         alert('Нет данных для отправки');
                         return;
                    }

                    console.log('Данные из файла:', this.fileData);
                    alert('Данные из файла готовы к отправке (см. консоль)');
               },
               updateCharCount(field, value) {
                    console.log('field', field, 'value', value);

                    // Обновляем текущее количество символов
                    this.charLimits[field].current = value.length;

                    // Возвращаем строку с информацией об оставшихся символах
                    const remaining = this.charLimits[field].max - value.length;
                    return `${remaining} / ${this.charLimits[field].max}`;
               },
               showModalScanGTIN() {
                    const myModalAlternative = new bootstrap.Modal('#exampleModal');
                    myModalAlternative.show();
                    this.scanGTIN();
               },
               scanGTIN() {
                    let selectedDeviceId;
                    console.log('ZXing code reader initialized');
                    this.codeReader
                         .listVideoInputDevices()
                         .then((videoInputDevices) => {
                              const sourceSelect = document.getElementById('sourceSelect');
                              selectedDeviceId = videoInputDevices[0].deviceId;
                              if (videoInputDevices.length >= 1) {
                                   videoInputDevices.forEach((element) => {
                                        const sourceOption = document.createElement('option');
                                        sourceOption.text = element.label;
                                        sourceOption.value = element.deviceId;
                                        sourceSelect.appendChild(sourceOption);
                                   });

                                   sourceSelect.onchange = () => {
                                        selectedDeviceId = sourceSelect.value;
                                   };

                                   const sourceSelectPanel = document.getElementById('sourceSelectPanel');
                                   sourceSelectPanel.style.display = 'block';
                              }

                              this.codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                                   if (result) {
                                        console.log(result);
                                        document.getElementById('result').textContent = result.text;
                                   }
                                   if (err && !(err instanceof ZXing.NotFoundException)) {
                                        console.error(err);
                                        document.getElementById('result').textContent = err;
                                   }
                              });
                              console.log(`Started continous decode from camera with id ${selectedDeviceId}`);

                              document.getElementById('startButton').addEventListener('click', () => {});

                              // document.getElementById('resetButton').addEventListener('click', () => {
                              //      this.codeReader.reset();
                              //      document.getElementById('result').textContent = '';
                              //      console.log('Reset.');
                              // });
                         })
                         .catch((err) => {
                              console.error(err);
                         });
               },
          },
          mounted() {},
     }).mount('#app');
</script>
